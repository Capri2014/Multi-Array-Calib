function [ output_args ] = ladybugToCylinder()
%LADYBUGTOCYLINDER Summary of this function goes here
%   Detailed explanation goes here

folder = '/home/z/Documents/Datasets/IJRR-Dataset-1/Processed/ladybug/';

files = [dir([folder,'/camera_0/*.jpg']);dir([folder,'/camera_0/*.png'])];

out = zeros(1000,2000);

for j = 1:5
    mask{j} = imread([folder,'/masks/cam',num2str(j-1),'.png']);
    mask{j} = logical(mask{j}(:,:,1));
    mask{j} = mask{j}(:);
end

for i = 1:length(files)
    pan = cell(5,1);
    for j = 1:5
        image = double(imread([folder,'/camera_',num2str(j-1),'/',files(i).name]))/255;
        
        switch j
            case 1
                K = [408.397136 0 631.070016 0; 0 408.397136 806.586960 0; 0 0 1 0];
                T = [-0.00352220756688916,0.000476706414876329,-0.999993683382475,0.0421520000000000;-0.00242314359211904,0.999996946452598,0.000485242839019936,-0.00181800000000000;0.999990861172735,0.00242483741204713,-0.00352104168356686,-0.000285000000000000;0,0,0,1];
            case 2
                K = [402.206240 0 624.348224 0; 0 402.206240 784.646528 0; 0 0 1 0];
                T = [0.00404706077763248,0.00229056029211819,-0.999989187257848,0.0110770000000000;-0.952040830777285,0.305954768241988,-0.00315219334547793,-0.0401670000000000;0.305944239743059,0.952043293723316,0.00341892446573545,2.10000000000000e-05;0,0,0,1];
            case 3
                K = [398.799712 0 629.331664 0; 0 398.799712 818.201152 0; 0 0 1 0];
                T = [0.00363032498886248,8.51757625159609e-05,-0.999993406721047,-0.0346410000000000;-0.588951376995450,-0.808165456432402,-0.00220693556106403,-0.0233570000000000;-0.808160315949526,0.588955505768048,-0.00288373886900159,0.000269000000000000;0,0,0,1];
            case 4
                K = [406.131504 0 622.543536 0; 0 406.131504 820.718880 0; 0 0 1 0];
                T = [-0.00746675324824337,0.00389850357987074,-0.999964524003611,-0.0331330000000000;0.588700654178876,-0.808315891192417,-0.00754717266078323,0.0258970000000000;-0.808316638060416,-0.588736122312574,0.00374044369837912,-0.000102000000000000;0,0,0,1];
            case 5
                K = [400.730832 0 618.114496 0; 0 400.730832 796.724512 0; 0 0 1 0];
                T = [-0.00753052778643574,-0.00413314766558126,-0.999963103440138,0.0145440000000000;0.951060562430353,0.308889284586203,-0.00843898438696812,0.0394450000000000;0.308912767202842,-0.951089021573795,0.00160477440292676,9.70000000000000e-05;0,0,0,1];
        end
        
        %base = [-0.00352220756688916,0.000476706414876329,-0.999993683382475,0.0421520000000000;-0.00242314359211904,0.999996946452598,0.000485242839019936,-0.00181800000000000;0.999990861172735,0.00242483741204713,-0.00352104168356686,-0.000285000000000000;0,0,0,1];
        %T = base/T;
        T = angle2dcm(0,-72*(j-1)*pi/180,0);
        
        [xq,yq] = meshgrid(0:(size(image,2)-1), 0:(size(image,1)-1));
        xq = (xq - K(1,3))./K(1,1);
        yq = (yq - K(2,3))./K(2,2);
        zq = ones(size(xq));
        
        ic = [xq(:),yq(:),zq(:)];
        ic = ic ./ repmat(sqrt(sum(ic.^2,2)),1,3);
        
        ic = (T(1:3,1:3)*ic')';

        ic(:,1) = atan2(ic(:,1),ic(:,3));
        
        %ic(ic(:,2) < 0,1) = ic(ic(:,2) < 0,2) + 2*pi;
         
        ic = [ic(:,1),ic(:,2)];
        
       
        
        pan{j} = [ic,reshape(image(:,:,1),size(ic,1),1),reshape(image(:,:,1),size(ic,1),1),reshape(image(:,:,1),size(ic,1),1)];
        pan{j} = pan{j}(mask{j},:);
    end
    
    pan = cell2mat(pan);
    pan(:,1) = pan(:,1) - min(pan(:,1));
    pan(:,1) = pan(:,1) / max(pan(:,1));
    pan(:,1) = (size(out,2)-1)*pan(:,1);
    
    pan(:,2) = pan(:,2) - min(pan(:,2));
    pan(:,2) = pan(:,2) / max(pan(:,2));
    pan(:,2) = (size(out,1)-1)*pan(:,2) + 1;

    pan(:,1:2) = round(pan(:,1:2));
    
    out(pan(:,2) + pan(:,1).*size(out,1)) = pan(:,3);
    out = imdilate(out,ones(2,2));
end

